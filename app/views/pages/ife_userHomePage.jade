extend ../layout

block headerContent
	link(rel="stylesheet",href="/css/ife.css")
	style.
		/* 微博内容部分 */
		.ife_weiboContent{width:922px;height:500px;background:#e5e5e5;margin:20px auto 0;}

block content
	// 导航部分
	include ./ife_nav
	.ife_weiboUserInfo
		.ife_weiboInfoContent
			p.ife_weiboUserAvatar
				a.ife_userAvatar(href="javascript:void(0);")
					img#J_userAvatar(src=avatar,width="100",height="100")
					if !avatarFlag
						input#J_uploadAvatar(type="file",name="avatar",style="display:none;")
			.ife_weiboUsername
				h1 #{username}
			.ife_weiboCreateTime
				h6 创建时间：#{moment(createTime).fromNow()}
	.ife_weiboContent

block footerContent
	script.
		$('#J_userAvatar').click(function (e) {
			if ($('#J_uploadAvatar').length) {
				$('#J_uploadAvatar').click();
			}
		});
		$('#J_uploadAvatar').change(function (e) {	
			var avatar = e.target.files[0];
			var imgRep = /^image\/(jpeg|jpg|gif|png|bmp$)/i;
			if (imgRep.test(avatar.type)) {
				var fr = new FileReader();
				fr.readAsDataURL(avatar);
				// 首先进行本地预览，本地预览成功后，上传到服务器
				fr.onload = function () {
					$('#J_userAvatar').attr('src', this.result);
					window.message['success'](window.message.infoCode['avatarLocalSuccess']);

					setTimeout(function () {
						var fd = new FormData();
						fd.append('avatar', avatar);
						$.ajax({
							url: '/user/avatarUpload',
							type: 'POST',
							data: fd,
							processData: false,
							contentType: false,
							beforeSend: function (xhr) {
								window.message['success'](window.message.infoCode['avatarUpload']);
							},
							success: function (data) {
								window.message['success'](window.message.infoCode['avatarUploadSuccess']);
								if ($('#J_uploadAvatar').length) {
									console.log('hehe');
									$('#J_uploadAvatar').remove();
								}
							},
							error: function () {
								window.message['error'](window.message.infoCode['avatarUploadError']);
								$('#J_userAvatar').attr('src', '/images/defaultAvatar.png');
							}
						});
					}, 1000);
				};
			} else {
				window.message['error'](window.message.infoCode['avatarError']);
			}
		});